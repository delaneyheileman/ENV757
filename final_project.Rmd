---
title: "Final Project"
author: "Delaney Heileman"
date: "4/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(car)
library(leaps)
library(lubridate)
library(rvest)
library(olsrr)
library(corrplot)
library(leaps)
library(tidyverse)
library(ggplot2)
source("http://www.reuningscherer.net/s&ds230/Rfuncs/regJDRS.txt")

```

## Loading Data 

```{r}
#Setting working directory 
#setwd("/Users/delaneyheileman/Documents/school/Yale/Spring 2022/data/ENV757")#
#setwd("/Users/liamgunn/Documents/School/Yale Forestry/Spring 2022/Data Exploration & Analysis/Data Analysis Final Project/ENV757")
setwd("/Users/elain/Documents/GitHub/ENV757")

#Loading CSV 
recs <- read.csv("recs2015_public_v4.csv")
#Gettign dimensions of our dataset 
dim(recs)
#Printing first 6 lines 
head(recs)

#Selecting columns we care about 
recs1 <- na.omit(recs[, c("MONEYPY", "ENERGYASST", "REGIONC", "DIVISION","UATYP10", "KOWNRENT", "THERMAIN", "PROTHERM", "TEMPHOME", "AIRCOND","CENACHP", "THERMAINAC", "PROTHERMAC", "TEMPHOMEAC", "HOUSEHOLDER_RACE", "SCALEB", "KWH", "DOLLAREL", "DOLLARNG", "DOLLARLP", "DOLLARFO")])

#Removing "not applicable" answers for thermostat questions. N/a for Thermostat likely means they use wood fire or something else
# <- recs1[recs1$THERMAIN != -2 & recs1$THERMAINAC != "-2",]

cleanRECS$REGIONC <- as.factor(recode(cleanRECS$REGIONC,
                             '1' = 'Northeast',
                             '2' = 'Midwest',
                             '3' = 'South',
                             '4' = 'West'))

#Changing C (suburban areas) into Urban
cleanRECS$UATYP10 <- recode(cleanRECS$UATYP10, 'C' = 'U')



cleanRECS$DIVISION <- as.factor(recode(cleanRECS$DIVISION,
                              '1' = 'New England',
                              '2' = 'Mid Atlantic',
                              '3' = 'East North Central',
                              '4' = 'West North Central',
                              '5' = 'South Atlantic',
                              '6' = 'East South Central',
                              '7' = 'West South Central',
                              '8' = 'Mountain North',
                              '9' = 'Mountain South',
                              '10'= 'Pacific'))

cleanRECS$CENACHP <- recode(cleanRECS$CENACHP,
                            '1' = 'YES',
                            '0' = 'NO')
#recoding energy assitance variable to yes or no value
cleanRECS$ENERGYASST <- recode(cleanRECS$ENERGYASST,
                            '1' = 'YES',
                            '0' = 'NO')
```

## DATA AND DATA CLEANING WRITE UP 

blah blah blah 

this is what we used ______ and the units were _____ 

clean was hard for x y and z reason 

```{r}
#boxplot of kilo watt hours based on area 
boxplot(KWH ~ UATYP10 , data = cleanRECS, col = as.factor(cleanRECS$KWH), xlab = "Rural or Urban")

#adding column for log KWH values
cleanRECS$logKWH <- log(cleanRECS$KWH)

#boxploot of log valeus 
boxplot(logKWH ~ UATYP10 , data = cleanRECS, col = as.factor(cleanRECS$logKWH), xlab = "Rural or Urban")

#WHY IS THIS DOING THIS!!!!!!!

#t.test of KWH and region type 
(test1 <- t.test(logKWH ~ UATYP10, data = cleanRECS, conf.level = .95))

##This is where bootstrapping starts! 

set.seed(230)

N <- 10000
sR <- rep(NA, N)
sU <- rep(NA, N)
diffvals <- rep(NA, N)

for (i in 1:N) {
  sR <- sample(cleanRECS$logKWH[cleanRECS$UATYP10 == "R"],
               sum(cleanRECS$UATYP10 == "R"), replace = TRUE)

  sU <- sample(cleanRECS$logKWH[cleanRECS$UATYP10 == "U"],
               sum(cleanRECS$UATYP10 == "U"), replace = TRUE)
diffvals[i] <- mean(log(sR)) - mean(log(sU))

}

ci <- quantile(diffvals, c(0.025, 0.975))
round(ci, 2)

hist(diffvals, 
     col = "blue", 
     main = "Bootstrapped Sample Means Diff in KiloWattHours", 
     xlab = "", 
     breaks = 50, 
     xlim = c(0.03, 1))

#Add lines to histogram for CI's
abline(v = ci, lwd=3, col="red")
abline(v = test1$conf.int, lwd = 3, col = "green", lty = 2)
legend("topleft", 
       c("Original CI","Boot CI"), 
       lwd = 3, 
       col = c("green","red"), 
       lty = c(2,1))

```



##ANCOVA AREA - ELAINE !!!!!!!
```{r}
## ANCOVA - Analysis of Covariance - ELAINE
  
#This r-markdown is for the purposes of analyzing the continuous variables of kilowatt-hours versus the continuous variable annual gross income and heat pump 

ancmod <- cleanRECS[c("KWH", "MONEYPY", "CENACHP")]

ancmod$CENACHP <- as.factor(ancmod$CENACHP)

dim(ancmod)
str(ancmod)
```

## Exploratory Data Analysis 
```{r}

attach(ancmod)
boxplot(KWH ~ MONEYPY, data = ancmod, col = "green", xlab = "Annual Gross Income")
boxplot(KWH ~ CENACHP, data = ancmod, col = "yellow", xlab = "Heat Pump")

dim(ancmod)

```
*The initial boxplots indicate that annual gross income may have a statistically 

## Assumption Verification

The following assumptions must be met in order to proceed with an ANCOVA analysis: the dependent variables should be normally distributed, data should have approximately the same variance

```{r}
#Check Variance Assumption !! check to see if I should do run this assumption again 

stdev1 <- tapply(KWH, MONEYPY, sd)
round(max(stdev1)/min(stdev1),1)

stdev2 <- tapply(KWH, CENACHP, sd)
max(stdev2)/min(stdev2)

#check normality assumptions for KWH and MONEYPY
m1 <- lm(KWH ~ MONEYPY, data = ancmod)
plot(ancmod$KWH ~ ancmod$MONEYPY, data = ancmod, pch = 19, main = "Kilowatt Hours by Gross Annual Income", col = "red")
summary(m1)

#checking normality 
myResPlots2(m1)

trans1 <- boxCox(m1)
trans1$x[which.max(trans1$y)]


#log transformation !!! check with prof if I can do this 
ancmod$transKWH <- (ancmod$KWH)^(1/4)
ancmod <- ancmod[-4913, ]

m2 <- lm(transKWH ~ MONEYPY, data = ancmod)
summary(m2)
myResPlots2(m2)

ancmod[3365,]
ancmod[4913,] 

#check normality assumptions for KWH and CENACHP

m3 <- lm(transKWH ~ CENACHP, data = ancmod)
summary(m3)
myResPlots2(m3)



```


*The residual plots show an unequal spread of points about 0 which indicates multiple outliers or influential points. The normal quantile plot is not straight indicating evidence of heteroskedasticity. The boxcox lambda value is 0.22 which suggests a transformation to the power of a 1/4 or we could round to 0 which would suggest a transformation of log. After transformation, we manage to fix some of the heteroskedasticity.* 

```{r}
fitanco <- lm(transKWH ~ MONEYPY + CENACHP + MONEYPY*CENACHP, data = ancmod)


Anova(fitanco, type = 3) 
summary(fitanco)

anccoef <- coef(fitanco)
plot(transKWH ~ MONEYPY, data = ancmod, col = factor(CENACHP), pch = 16, cex = .5)
legend("topright", col = 1:2, legend = levels(factor(ancmod$CENACHP)), pch = 16)
abline(a = anccoef[1], b = anccoef[2], col = 1, lwd = 3)
abline(a = anccoef[1] + anccoef[3], b = anccoef[2] + anccoef[4], col = 2, lwd = 3)
```
##GLM AREA 
```{r}
cleanRECS$IncBracket <- as.numeric(recode(cleanRECS$MONEYPY,
                             '1 - 20k' = '20000',
                             '2 - 40k' = '40000',
                             '3 - 60k' = '60000',
                             '4 - 80k' = '80000',
                             '5 - 100k' = '100000',
                             '6 - 120k' = '120000',
                             '7 - 140k' = '140000',
                             '8 - 140k+' = 'NA'))
cleanRECS$logIncBracket <- log(cleanRECS$IncBracket)
```


```{r}
##FROM CLASS 19
#Creating the linear model

mod1 <- regsubsets(logKWH ~ logIncBracket + DIVISION + UATYP10 + KOWNRENT + DIVISION*UATYP10,
                   data = cleanRECS, nvmax = 7)
mod1sum <- summary(mod1)
mod1sum$which
mod1sum$which[1, ]
```

*This model finds that the household's location in either an urban vs. rural area is the only significant predictor of household energy use.*

*To show this visually, the following figure plots median income vs. household energy use on a log-log scale. The trend lines illustrate the OLS best fit lines for urban and for rural households differ significantly only in their y-intercept, but not in their slopes. In other words, being in an urban vs. rural area has a significant effect on household energy use, and there is not an interaction effect with median household income.*

```{r}
lm1 <- lm(cleanRECS$logKWH ~ cleanRECS$logIncBracket*cleanRECS$UATYP10)
summary(lm1)
coefs <- round(coef(lm1), 2)

#Plotting the model to show the lack of impact of household income, but impact of housing type.
plot(cleanRECS$logKWH ~ cleanRECS$logIncBracket,
     col = factor(cleanRECS$UATYP10), 
     pch = 16,
     cex = .5,
     main = "Energy Consumption vs. Household Income (Log-Log)",
     xlab = "Log of Household Income Bracket ($)",
     ylab = "Log of Energy Consumption (kWh)")
legend("topleft", col = 1:5, legend = c("Rural", "Urban"), pch = 16)
abline(a = coefs[1], b = coefs[2], col = 1, lwd = 3)
abline(a = coefs[1] + coefs[3], b = coefs[2] + coefs[4], col = 2, lwd = 3)
text(x = 10.25, y = 9.75, col = 1,
     paste0("Slope = ", coefs[2]))
text(x = 10.25, y = 8.5, col = 2,
     paste0("Slope = ", coefs[2] + coefs[4]))
text(x = 10.25, y = 8.15, col = 2, paste0("but, p = ", round(summary(lm1)$coefficients[4, 4], 2)))
text(x = 10.95, y = 6, col = 1, paste0("Rural energy use tends to be ", round(exp(coefs[3]), 2) ," kWh/year"))
text(x = 10.95, y = 5.65, col = 1, paste0("higher than urban, p-value = ", round(summary(lm1)$coefficients[2, 4], 5)))
```


