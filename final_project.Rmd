---
title: "Final Project"
author: "Delaney Heileman"
date: "4/26/2022"
output: html_document
---
## Introduction - Background and Motivation 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(car)
library(leaps)
library(lubridate)
library(rvest)
library(olsrr)
library(corrplot)
library(leaps)
library(tidyverse)
library(ggplot2)
source("http://www.reuningscherer.net/s&ds230/Rfuncs/regJDRS.txt")

```
## Data - Variables Used


**ANCOVA Model** 
*The ANCOVA model used three variables. The dependent variable was a continuous fourth root transformed kilowatt hour variable (transKWH) and the independent variables were a continuous variable of annual gross income (MONEYPY) and a categorical variable of whether a household had a heat pump (CENACHP). The MONEYPY variable is ordered from lowest income (1 - <20,000 USD) to highest income (8 - >120,000 USD). CENACHP records 'No' for no heat pump and 'Yes' for having a heat pump*

*   KWH (continuous): on a scale of kilowatt-hours used in the US in the year 2015
*   CENACHP (categorical): the presence of a heat pump "Yes" or "No"
*   MONEYPY (continuous): Gross annual income of a household in the year 2015. 8 levels. 	
  1 -	Less than $20,000
	2	- $20,000 - $39,999
	3	- $40,000 - $59,999
	4 -	$60,000 to $79,999
	5	- $80,000 to $99,999
	6	- $100,000 to $119,999
	7	- $120,000 to $139,999
	8	- $140,000 or more


## Loading Data and Data Cleaning

```{r}
#Setting working directory 
#setwd("/Users/delaneyheileman/Documents/school/Yale/Spring 2022/data/ENV757")#
#setwd("/Users/liamgunn/Documents/School/Yale Forestry/Spring 2022/Data Exploration & Analysis/Data Analysis Final Project/ENV757")
setwd("/Users/elain/Documents/GitHub/ENV757")

#Loading CSV 
recs <- read.csv("recs2015_public_v4.csv")
#Gettign dimensions of our dataset 
dim(recs)
#Printing first 6 lines 
head(recs)

#Selecting columns we care about 
recs1 <- na.omit(recs[, c("MONEYPY", "ENERGYASST", "REGIONC", "DIVISION","UATYP10", "KOWNRENT", "THERMAIN", "PROTHERM", "TEMPHOME", "AIRCOND","CENACHP", "THERMAINAC", "PROTHERMAC", "TEMPHOMEAC", "HOUSEHOLDER_RACE", "SCALEB", "KWH", "DOLLAREL", "DOLLARNG", "DOLLARLP", "DOLLARFO")])

#Removing "not applicable" answers for thermostat questions. N/a for Thermostat likely means they use wood fire or something else
cleanRECS <- recs1[recs1$THERMAIN != -2 & recs1$THERMAINAC != "-2",]

cleanRECS$REGIONC <- as.factor(recode(cleanRECS$REGIONC,
                             '1' = 'Northeast',
                             '2' = 'Midwest',
                             '3' = 'South',
                             '4' = 'West'))

#Changing C (suburban areas) into Urban
cleanRECS$UATYP10 <- recode(cleanRECS$UATYP10, 'C' = 'U')



cleanRECS$DIVISION <- as.factor(recode(cleanRECS$DIVISION,
                              '1' = 'New England',
                              '2' = 'Mid Atlantic',
                              '3' = 'East North Central',
                              '4' = 'West North Central',
                              '5' = 'South Atlantic',
                              '6' = 'East South Central',
                              '7' = 'West South Central',
                              '8' = 'Mountain North',
                              '9' = 'Mountain South',
                              '10'= 'Pacific'))

cleanRECS$CENACHP <- recode(cleanRECS$CENACHP,
                            '1' = 'YES',
                            '0' = 'NO')
#recoding energy assitance variable to yes or no value
cleanRECS$ENERGYASST <- recode(cleanRECS$ENERGYASST,
                            '1' = 'YES',
                            '0' = 'NO')
```

## DATA AND DATA CLEANING WRITE UP 

blah blah blah 

this is what we used ______ and the units were _____ 

clean was hard for x y and z reason 

```{r}
#boxplot of kilo watt hours based on area 
boxplot(KWH ~ UATYP10 , data = cleanRECS, col = as.factor(cleanRECS$KWH), xlab = "Rural or Urban")

#adding column for log KWH values
cleanRECS$logKWH <- log(cleanRECS$KWH)

#boxploot of log valeus 
boxplot(logKWH ~ UATYP10 , data = cleanRECS, col = as.factor(cleanRECS$logKWH), xlab = "Rural or Urban")

#WHY IS THIS DOING THIS!!!!!!!

#t.test of KWH and region type 
(test1 <- t.test(logKWH ~ UATYP10, data = cleanRECS, conf.level = .95))

##This is where bootstrapping starts! 

set.seed(230)

N <- 10000
sR <- rep(NA, N)
sU <- rep(NA, N)
diffvals <- rep(NA, N)

for (i in 1:N) {
  sR <- sample(cleanRECS$logKWH[cleanRECS$UATYP10 == "R"],
               sum(cleanRECS$UATYP10 == "R"), replace = TRUE)

  sU <- sample(cleanRECS$logKWH[cleanRECS$UATYP10 == "U"],
               sum(cleanRECS$UATYP10 == "U"), replace = TRUE)
diffvals[i] <- mean(log(sR)) - mean(log(sU))

}

ci <- quantile(diffvals, c(0.025, 0.975))
round(ci, 2)

hist(diffvals, 
     col = "blue", 
     main = "Bootstrapped Sample Means Diff in KiloWattHours", 
     xlab = "", 
     breaks = 50, 
     xlim = c(0.03, 1))

#Add lines to histogram for CI's
abline(v = ci, lwd=3, col="red")
abline(v = test1$conf.int, lwd = 3, col = "green", lty = 2)
legend("topleft", 
       c("Original CI","Boot CI"), 
       lwd = 3, 
       col = c("green","red"), 
       lty = c(2,1))

```



#ANCOVA -  Analysis of Covariance - ELAINE !!!!!!!

*The ANCOVA model aims to fit a model predicting the continuous variable kilowatt hours 'KWH' based on and the categorical variable of whether households have a heat pump or not 'CENACHP' whether there is a significant interaction between the continuous variable of annual gross income 'MONEYPY and having a heat pump.* 

```{r}
# Subset the dataset used for the ANCOVA model, clean the data, and check the characteristics of the dataset.

ancmod <- cleanRECS[c("KWH", "MONEYPY", "CENACHP")]

ancmod$CENACHP <- as.factor(ancmod$CENACHP)

dim(ancmod)
str(ancmod)
```

## Exploratory Data Analysis 
```{r}
#Create initial exploratory boxplots and scatterplots to determine whether the spread and the means of the data indicate similar variance or evidence of related variables. Only a scatterplot is made for KWH vs. MONEYPY because they are the only continuous variables.  

attach(ancmod)
boxplot(KWH ~ MONEYPY, data = ancmod, col = terrain.colors(8), xlab = "Annual Gross Income", ylab = "Kilowatt-Hours")
boxplot(KWH ~ CENACHP, data = ancmod, col = c("red3", "green3"), xlab = "Heat Pump", ylab = "Kilowatt-Hours")

plot(KWH ~ MONEYPY, data = ancmod, col = "plum4", pch = 21, xlab = "Annual Gross Income", main = "Scatterplot of Kilowatt-Hours versus Annual Gross Income", ylab = "Kilowatt-Hours")



```
*The initial boxplots indicate that kilowatt hour means vary across annual gross income and kilowatt hour means may vary across having or not having a heat pump. The spreads of annual gross income and the presence of a heat pump aren't vastly different. However, boxplots are not a true indication of interactions occuring between variables so other tests need to be completed to verify interactions.* 

## Assumption Verification

*The following assumptions must be met in order to proceed with an ANCOVA analysis: the dependent variables should be normally distributed, data should have approximately the same variance.*

```{r}
#Check Variance Assumption

stdev1 <- tapply(KWH, MONEYPY, sd)
round(max(stdev1)/min(stdev1),1)

stdev2 <- tapply(KWH, CENACHP, sd)
round(max(stdev2)/min(stdev2),1)

```
*The variances of the KWH and MONEYPY is 1.5 and the variances of KWH and CENACHP are 1.2 so we statisfy the equal variances assumption to conduct an ANCOVA test.*


```{r}
#check normality assumptions for KWH and MONEYPY

m1 <- lm(KWH ~ CENACHP, data = ancmod)
summary(m1)
myResPlots2(m1)


m2 <- lm(KWH ~ MONEYPY, data = ancmod)
plot(ancmod$KWH ~ ancmod$MONEYPY, data = ancmod, pch = 19, main = "Kilowatt Hours by Gross Annual Income", col = "red")
summary(m2)
myResPlots2(m2)


#Normality assumptions have not been met by the residuals so a transformation needs to be made. A box cox test will indicate what transformation is approprite for the data. 
trans1 <- boxCox(m1)
boxcoxtrans <- trans1$x[which.max(trans1$y)]
print(boxcoxtrans)

```
*Normality of the model for the first 'm1' model fitting  KWH and CENACHP show evidence of non normality from the normal quantile plot which is not linear and evidence of outliers and influential points from the residual plots which show a heavy skew of positive residuals. This model has a r-squared value of 0.064 meaning 6.4% of the variability of kilowatt hour usage is explained by the presence of a heat pump. The 'CENACHP' variable has a lower p-value of less than 2e-16 meaning it is a statistically significant predictor of kilowatt hours. The second model 'm2' fitting KWH and MONEYPY also show similar evidence of non-normality from a non linear and curved normal quantile plot and residuals heavily positive skewed showing evidence of outliers and influential points. This indicates that the response variable needs some transformation. The 'm2' model has a r-squared value of 0.05306 meaning 5.3% of the predictabilit yof kilowatt-hour usage can be explained by the variable annual gross income or 'MONEYPY'. Like CENACHP, MONEYPY has a low p-value of less than 2e-16 meaning it is a statistically significant predictor. A box cox transformation results in a lambda of 0.26 which is approximately 0.2 which indicates a fourth root transformation would suit the dependent variable. *

```{r}
#Fourth Root Transformation 
ancmod$transKWH <- (ancmod$KWH)^(1/4)


#check normality assumptions for KWH and CENACHP and KWH and MONEYPY

m3 <- lm(transKWH ~ CENACHP, data = ancmod)
summary(m3)
myResPlots2(m3)
ols_plot_cooksd_bar(m3)


m4 <- lm(transKWH ~ MONEYPY, data = ancmod)
summary(m4)
myResPlots2(m4)

ols_plot_cooksd_bar(m4)



```


*After transformation, model assumptions have been reasonably met after transformation. We manage to fix some of the heteroskedasticity and the residual plots are approximately normally distributed with equal spread around the 0. The normal quantile plot is approximately linear which shows that transformation has eliminated some heteroskedasticity. There are a few extreme outliers though. The cooks bars indicate that each model has several points which are outliers and could affect the model results; however, the model has over 3000 points which will will still yield insight from the data. # check what to say about the outliers !!!!!! After the transformation the refitted model 'm3' of the transformed KWH and CENACHP has a lower r-squared value of 0.063 meaning the predictability of KWH is 6.3% explained by our model. CENACHP is still statistically significant as a predictor. The refitted model 'm4' of the transformed KWH and MONEYPY has an improved r-squared value of 0.0558 meaning our model can predict 5.5% of KWH with the variable MONEYPY. MONEYPY is still a statistically significant predictor. *


##Permutation Test
*Our permutation test null hypothesis: there is no significant effect of having a heat pump on kilowatt hours used controlling for annual gross income.*
*The alternative hypothesis: there is a significant effect of having a heat pump on kilowatt hours used controlling for annual gross income.* 

*In other words, we are trying to predict transformed KWH based on annual gross income, but fitting separate slopes for whether there is a the a heat pump or not in the household.*
$$
H_0 : \mu_1 = \mu_2 = ... = \mu_k \\ 
H_a : \mu_i \ne \mu_k 
$$

```{r}
fitanco <- lm(transKWH ~ MONEYPY + CENACHP + MONEYPY*CENACHP, data = ancmod)


Anova(fitanco, type = 3) 
summary(fitanco)
vif(fitanco)

anccoef <- coef(fitanco)
plot(transKWH ~ MONEYPY, data = ancmod, col = factor(CENACHP), pch = 16, cex = .5)
legend("topright", col = 1:2, legend = levels(factor(ancmod$CENACHP)), pch = 16)
abline(a = anccoef[1], b = anccoef[2], col = 1, lwd = 3)
abline(a = anccoef[1] + anccoef[3], b = anccoef[2] + anccoef[4], col = 2, lwd = 3)
```
*The final fitted ANCOVA model is the transformed kilowatt hour variable (transKWH) predicted by annual gross income (MONEYPY), the presence of a heat pump (CENACHP), and the interaction of MONEYPY x CENACHP. The r-squared of this model improved from our separated predictors and our model explains 11.7% of the predictability of transformed kilowatt hours. Each of the predictors have p-values less than our alpha 0.05 meaning they are statistically significant predictors. Additionally, the interaction term between MONEYPY and CENACHP is statistically significant with a p-value of 4.5e-4. The model indicates that with there is a higher kilowatt usage with a higher gross annual income at a rate of (9.48 + 0.13 = 9.61). The presence of a heat pump means an increase in kilowatt hours at a rate of (9.48 + 0.48 = 10.96). The presence of a heat pump and a higher annual gross income have a increase in kilowatt hour usage at the rate of 9.48 + 0.08 = 9.56.* 





##GLM AREA 
```{r}
cleanRECS$IncBracket <- as.numeric(recode(cleanRECS$MONEYPY,
                             '1 - 20k' = '20000',
                             '2 - 40k' = '40000',
                             '3 - 60k' = '60000',
                             '4 - 80k' = '80000',
                             '5 - 100k' = '100000',
                             '6 - 120k' = '120000',
                             '7 - 140k' = '140000',
                             '8 - 140k+' = 'NA'))
cleanRECS$logIncBracket <- log(cleanRECS$IncBracket)
```


```{r}
##FROM CLASS 19
#Creating the linear model

mod1 <- regsubsets(logKWH ~ logIncBracket + DIVISION + UATYP10 + KOWNRENT + DIVISION*UATYP10,
                   data = cleanRECS, nvmax = 7)
mod1sum <- summary(mod1)
mod1sum$which
mod1sum$which[1, ]
```

*This model finds that the household's location in either an urban vs. rural area is the only significant predictor of household energy use.*

*To show this visually, the following figure plots median income vs. household energy use on a log-log scale. The trend lines illustrate the OLS best fit lines for urban and for rural households differ significantly only in their y-intercept, but not in their slopes. In other words, being in an urban vs. rural area has a significant effect on household energy use, and there is not an interaction effect with median household income.*

```{r}
lm1 <- lm(cleanRECS$logKWH ~ cleanRECS$logIncBracket*cleanRECS$UATYP10)
summary(lm1)
coefs <- round(coef(lm1), 2)

#Plotting the model to show the lack of impact of household income, but impact of housing type.
plot(cleanRECS$logKWH ~ cleanRECS$logIncBracket,
     col = factor(cleanRECS$UATYP10), 
     pch = 16,
     cex = .5,
     main = "Energy Consumption vs. Household Income (Log-Log)",
     xlab = "Log of Household Income Bracket ($)",
     ylab = "Log of Energy Consumption (kWh)")
legend("topleft", col = 1:5, legend = c("Rural", "Urban"), pch = 16)
abline(a = coefs[1], b = coefs[2], col = 1, lwd = 3)
abline(a = coefs[1] + coefs[3], b = coefs[2] + coefs[4], col = 2, lwd = 3)
text(x = 10.25, y = 9.75, col = 1,
     paste0("Slope = ", coefs[2]))
text(x = 10.25, y = 8.5, col = 2,
     paste0("Slope = ", coefs[2] + coefs[4]))
text(x = 10.25, y = 8.15, col = 2, paste0("but, p = ", round(summary(lm1)$coefficients[4, 4], 2)))
text(x = 10.95, y = 6, col = 1, paste0("Rural energy use tends to be ", round(exp(coefs[3]), 2) ," kWh/year"))
text(x = 10.95, y = 5.65, col = 1, paste0("higher than urban, p-value = ", round(summary(lm1)$coefficients[2, 4], 5)))
```


